import java.io.FileNotFoundException;
import java.io.IOException;
import java.io.PrintWriter;
import java.sql.DriverManager;
import java.sql.SQLException;

import javax.servlet.ServletException;
import javax.servlet.annotation.WebServlet;
import javax.servlet.http.HttpServlet;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;

import java.sql.Connection;
import java.sql.DriverManager;
import java.sql.Statement;
import java.sql.PreparedStatement;
//import java.sql.Connection;
//import java.sql.PreparedStatement;
import java.sql.ResultSet;
//import java.sql.Statement;
import java.util.ArrayList;
import java.util.List;
/**
 * Servlet implementation class Connect
 */
@WebServlet("/userDAO")
public class userDAO 
{
	private static final long serialVersionUID = 1L;
	private Connection connect = null;
	private Statement statement = null;
	private PreparedStatement preparedStatement = null;
	private ResultSet resultSet = null;
	
	public userDAO(){}
	
	/** 
	 * @see HttpServlet#HttpServlet()
     */
    protected void connect_func() throws SQLException {
    	//uses default connection to the database
        if (connect == null || connect.isClosed()) {
            try {
                Class.forName("com.mysql.cj.jdbc.Driver");
            } catch (ClassNotFoundException e) {
                throw new SQLException(e);
            }
            connect = (Connection) DriverManager.getConnection("jdbc:mysql://127.0.0.1:3306/projectdb?allowPublicKeyRetrieval=true&useSSL=false&user=john&password=pass1234");
            System.out.println(connect);
        }
    }
    
    public boolean database_login(String email, String password) throws SQLException{
    	try {
    		connect_func("root","pass1234");
    		String sql = "select * from user where email = ?";
    		preparedStatement = connect.prepareStatement(sql);
    		preparedStatement.setString(1, email);
    		ResultSet rs = preparedStatement.executeQuery();
    		return rs.next();
    	}
    	catch(SQLException e) {
    		System.out.println("failed login");
    		return false;
    	}
    }
	//connect to the database 
    public void connect_func(String username, String password) throws SQLException {
        if (connect == null || connect.isClosed()) {
            try {
                Class.forName("com.mysql.cj.jdbc.Driver");
            } catch (ClassNotFoundException e) {
                throw new SQLException(e);
            }
            connect = (Connection) DriverManager
  			      .getConnection("jdbc:mysql://127.0.0.1:3306/userdb?"
  			          + "useSSL=false&user=" + username + "&password=" + password);
            System.out.println(connect);
        }
    }
    
    public List<user> listAllUsers() throws SQLException {
        List<user> listUser = new ArrayList<user>();        
        String sql = "SELECT * FROM Client";      
        connect_func();      
        statement = (Statement) connect.createStatement();
        ResultSet resultSet = statement.executeQuery(sql);
         
        while (resultSet.next()) {
            String email = resultSet.getString("Email");
            String firstName = resultSet.getString("FirstName");
            String lastName = resultSet.getString("LastName");
            String password = resultSet.getString("Password");
            String creditcard = resultSet.getString("CreditCardInformation");
            String adress = resultSet.getString("Address"); 
            String phone = resultSet.getString("PhoneNumber");

             
            user users = new user(email,firstName, lastName, password, creditcard, adress, phone);
            listUser.add(users);
        }        
        resultSet.close();
        disconnect();        
        return listUser;
    }
    
    protected void disconnect() throws SQLException {
        if (connect != null && !connect.isClosed()) {
        	connect.close();
        }
    }
    
    public void insert(user users) throws SQLException {
    	connect_func("root","pass1234");         
		String sql = "insert into Client(Email, FirstName, LastName, Password, CreditCardInformation,Adress,PhoneNumber) values (?, ?, ?, ?, ?, ?, ?)";
		preparedStatement = (PreparedStatement) connect.prepareStatement(sql);
			preparedStatement.setString(1, users.getEmail());
			preparedStatement.setString(2, users.getFirstName());
			preparedStatement.setString(3, users.getLastName());
			preparedStatement.setString(4, users.getPassword());
			preparedStatement.setString(5, users.getCreditcard());
			preparedStatement.setString(6, users.getAdress());		
			preparedStatement.setString(7, users.getPhone());		

		preparedStatement.executeUpdate();
        preparedStatement.close();
    }
    
    public boolean delete(String email) throws SQLException {
        String sql = "DELETE FROM Client WHERE Email = ?";        
        connect_func();
         
        preparedStatement = (PreparedStatement) connect.prepareStatement(sql);
        preparedStatement.setString(1, email);
         
        boolean rowDeleted = preparedStatement.executeUpdate() > 0;
        preparedStatement.close();
        return rowDeleted;     
    }
     
    public boolean update(user users) throws SQLException {
        String sql = "update Client set FirstName=?, LastName =?,Password = ?,CreditCardInformation=?,Adress=?, PhoneNumber =? where Email = ?";
        connect_func();
        
        preparedStatement = (PreparedStatement) connect.prepareStatement(sql);
        preparedStatement.setString(1, users.getEmail());
		preparedStatement.setString(2, users.getFirstName());
		preparedStatement.setString(3, users.getLastName());
		preparedStatement.setString(4, users.getPassword());
		preparedStatement.setString(5, users.getCreditcard());
		preparedStatement.setString(6, users.getAdress());			
		preparedStatement.setString(7, users.getPhone());
         
        boolean rowUpdated = preparedStatement.executeUpdate() > 0;
        preparedStatement.close();
        return rowUpdated;     
    }
    
    public user getUser(String email) throws SQLException {
    	user user = null;
        String sql = "SELECT * FROM Client WHERE Email = ?";
         
        connect_func();
         
        preparedStatement = (PreparedStatement) connect.prepareStatement(sql);
        preparedStatement.setString(1, email);
         
        ResultSet resultSet = preparedStatement.executeQuery();
         
        if (resultSet.next()) {
            String firstName = resultSet.getString("FirstName");
            String lastName = resultSet.getString("LastName");
            String password = resultSet.getString("Password");
            String creditcard = resultSet.getString("CreditCardInformation");
            String adress = resultSet.getString("Adress"); 
            String phone = resultSet.getString("PhoneNumber");
            user = new user(email, firstName, lastName, password, creditcard, adress,phone);
        }
         
        resultSet.close();
        statement.close();
         
        return user;
    }
    
    public boolean checkEmail(String email) throws SQLException {
    	boolean checks = false;
    	String sql = "SELECT * FROM Client WHERE Email = ?";
    	connect_func();
    	preparedStatement = (PreparedStatement) connect.prepareStatement(sql);
        preparedStatement.setString(1, email);
        ResultSet resultSet = preparedStatement.executeQuery();
        
        System.out.println(checks);	
        
        if (resultSet.next()) {
        	checks = true;
        }
        
        System.out.println(checks);
    	return checks;
    }
    
    public boolean checkAddress(String address) throws SQLException {
    	boolean checks = false;
    	String sql = "SELECT * FROM Client WHERE Address = ?";
    	connect_func();
    	preparedStatement = (PreparedStatement) connect.prepareStatement(sql);
        preparedStatement.setString(1, address);
        ResultSet resultSet = preparedStatement.executeQuery();
        
        System.out.println(checks);	
        
        if (resultSet.next()) {
        	checks = true;
        }
        
        System.out.println(checks);
    	return checks;
    }
    
    public boolean checkPassword(String password) throws SQLException {
    	boolean checks = false;
    	String sql = "SELECT * FROM Client WHERE Password = ?";
    	connect_func();
    	preparedStatement = (PreparedStatement) connect.prepareStatement(sql);
        preparedStatement.setString(1, password);
        ResultSet resultSet = preparedStatement.executeQuery();
        
        System.out.println(checks);	
        
        if (resultSet.next()) {
        	checks = true;
        }
        
        System.out.println(checks);
       	return checks;
    }
    
    
    
    public boolean isValid(String email, String password) throws SQLException
    {
    	String sql = "SELECT * FROM Client";
    	connect_func();
    	statement = (Statement) connect.createStatement();
    	ResultSet resultSet = statement.executeQuery(sql);
    	
    	resultSet.last();
    	
    	int setSize = resultSet.getRow();
    	resultSet.beforeFirst();
    	
    	for(int i = 0; i < setSize; i++)
    	{
    		resultSet.next();
    		if(resultSet.getString("Email").equals(email) && resultSet.getString("Password").equals(password)) {
    			return true;
    		}		
    	}
    	return false;
    }
    
    
    public void init() throws SQLException, FileNotFoundException, IOException{
    	connect_func();
        statement =  (Statement) connect.createStatement();
        
        String[] INITIAL = {"drop database if exists projectdb; ",
					        "create database projectdb; ",
					        "use projectdb; ",
					        "drop table if exists Client; ",
					        "drop table if exists Tree; ",
					        "drop table if exists QuoteRequest; ",
					        "drop table if exists Quote; ",
					        "drop table if exists OrderOfWork; ",
					        "drop table if exists Bill; ",
					        "drop table if exists BillHistory; ",
        					};
        
        String clientTableCreation = (
        	    "CREATE TABLE Client (" +
        	    "ClientID INT AUTO_INCREMENT PRIMARY KEY," +
        	    "FirstName VARCHAR(255)," +
        	    "LastName VARCHAR(255)," +
        	    "Address VARCHAR(255)," +
        	    "CreditCardInformation VARCHAR(255)," +
        	    "PhoneNumber VARCHAR(15)," +
        	    "Email VARCHAR(255)," +
        	    "Password VARCHAR(255));"
        	);


        
        String treeTableCreation = (
        	    "CREATE TABLE Tree (" +
        	    "TreeID INT AUTO_INCREMENT PRIMARY KEY," +
        	    "Size VARCHAR(255)," +
        	    "Height FLOAT," +
        	    "Location VARCHAR(255)," +
        	    "DistanceToHouse FLOAT," +
        	    "Picture1 VARCHAR(255)," +
        	    "Picture2 VARCHAR(255)," +
        	    "Picture3 VARCHAR(255));"
        	);

        
        String quoteRequestTableCreation = (
        	    "CREATE TABLE QuoteRequest (" +
        	    "QuoteRequestID INT AUTO_INCREMENT PRIMARY KEY," +
        	    "TreeID INT," +
        	    "ClientID INT," +
        	    "DateSubmitted DATE," +
        	    "Status ENUM('pending', 'accepted', 'rejected')," +
        	    "ClientNote TEXT," +
        	    "FOREIGN KEY (TreeID) REFERENCES Tree(TreeID)," +
        	    "FOREIGN KEY (ClientID) REFERENCES Client(ClientID));"
        	);

        
        String quoteTableCreation = (
        	    "CREATE TABLE Quote (" +
        	    "QuoteID INT AUTO_INCREMENT PRIMARY KEY," +
        	    "QuoteRequestID INT," +
        	    "Price DECIMAL(10, 2)," +
        	    "WorkPeriodStartDate DATE," +
        	    "WorkPeriodEndDate DATE," +
        	    "DateSubmitted DATE," +
        	    "Status ENUM('pending', 'accepted', 'rejected')," +
        	    "Note TEXT," +
        	    "FOREIGN KEY (QuoteRequestID) REFERENCES QuoteRequest(QuoteRequestID));"
        	);

        
        String orderOfWorkTableCreation = (
        	    "CREATE TABLE OrderOfWork (" +
        	    "OrderOfWorkID INT AUTO_INCREMENT PRIMARY KEY," +
        	    "QuoteID INT," +
        	    "DateCreated DATE," +
        	    "Status ENUM('in progress', 'completed')," +
        	    "FOREIGN KEY (QuoteID) REFERENCES Quote(QuoteID));"
        	);

        
        
        String billTableCreation = (
        	    "CREATE TABLE Bill (" +
        	    "BillID INT AUTO_INCREMENT PRIMARY KEY," +
        	    "OrderOfWorkID INT," +
        	    "AmountDue DECIMAL(10, 2)," +
        	    "DateIssued DATE," +
        	    "Status ENUM('pending', 'paid', 'disputed')," +
        	    "Note TEXT," +
        	    "FOREIGN KEY (OrderOfWorkID) REFERENCES OrderOfWork(OrderOfWorkID));"
        	);

        
        String billDisputeTableCreation = (
        	    "CREATE TABLE BillDispute (" +
        	    "DisputeID INT AUTO_INCREMENT PRIMARY KEY," +
        	    "BillID INT," +
        	    "ClientID INT," +
        	    "TimeAndDate DATETIME," +
        	    "Changelog TEXT," +
        	    "FOREIGN KEY (BillID) REFERENCES Bill(BillID)," +
        	    "FOREIGN KEY (ClientID) REFERENCES Client(ClientID));"
        	);

        
        
        
        String clientDataGeneration = (
        	    "INSERT INTO Client (FirstName, LastName, Address, CreditCardInformation, PhoneNumber, Email, Password) VALUES " +
        	    "('John', 'Doe', '123 Main St, Cityville', '**** **** **** 1234', '+1234567890', 'john.doe@email.com', 'password123'), " +
        	    "('Jane', 'Smith', '456 Oak St, Townsville', '**** **** **** 5678', '+9876543210', 'jane.smith@email.com', 'pass456'), " +
        	    "('Alice', 'Johnson', '789 Pine St, Villagetown', '**** **** **** 9876', '+1122334455', 'alice.johnson@email.com', 'secretPass'), " +
        	    "('Bob', 'Williams', '567 Elm St, Countryside', '**** **** **** 3456', '+4455667788', 'bob.williams@email.com', 'securePass123'), " +
        	    "('Eva', 'Miller', '890 Maple St, Suburbia', '**** **** **** 7890', '+9988776655', 'eva.miller@email.com', 'pass1234'), " +
        	    "('David', 'Jones', '234 Birch St, Riverside', '**** **** **** 2345', '+1122334455', 'david.jones@email.com', 'davidPass'), " +
        	    "('Sara', 'Davis', '678 Cedar St, Hillside', '**** **** **** 4567', '+3344556677', 'sara.davis@email.com', 'saraPass'), " +
        	    "('Mike', 'Taylor', '901 Redwood St, Lakeside', '**** **** **** 6789', '+8899001122', 'mike.taylor@email.com', 'mike123'), " +
        	    "('Grace', 'Anderson', '345 Fir St, Mountainside', '**** **** **** 2345', '+1122334455', 'grace.anderson@email.com', 'gracePass'), " +
        	    "('Peter', 'Brown', '123 Pine St, Oceanfront', '**** **** **** 4567', '+3344556677', 'peter.brown@email.com', 'peterPass');"
        	);


        
        String treeDataGeneration = (
        	    "INSERT INTO Tree (Size, Height, Location, DistanceToHouse, Picture1, Picture2, Picture3) VALUES " +
        	    "('Medium', 5.5, 'Front Yard', 10.2, 'tree1_pic1.jpg', 'tree1_pic2.jpg', 'tree1_pic3.jpg'), " +
        	    "('Large', 8.0, 'Back Yard', 15.0, 'tree2_pic1.jpg', 'tree2_pic2.jpg', 'tree2_pic3.jpg'), " +
        	    "('Small', 3.0, 'Side Yard', 5.5, 'tree3_pic1.jpg', 'tree3_pic2.jpg', 'tree3_pic3.jpg'), " +
        	    "('Medium', 6.0, 'Garden', 8.0, 'tree4_pic1.jpg', 'tree4_pic2.jpg', 'tree4_pic3.jpg'), " +
        	    "('Large', 7.5, 'Park', 20.0, 'tree5_pic1.jpg', 'tree5_pic2.jpg', 'tree5_pic3.jpg'), " +
        	    "('Small', 4.0, 'Street', 3.5, 'tree6_pic1.jpg', 'tree6_pic2.jpg', 'tree6_pic3.jpg'), " +
        	    "('Medium', 5.0, 'Schoolyard', 12.0, 'tree7_pic1.jpg', 'tree7_pic2.jpg', 'tree7_pic3.jpg'), " +
        	    "('Large', 9.0, 'Playground', 18.0, 'tree8_pic1.jpg', 'tree8_pic2.jpg', 'tree8_pic3.jpg'), " +
        	    "('Small', 3.5, 'Front Yard', 7.0, 'tree9_pic1.jpg', 'tree9_pic2.jpg', 'tree9_pic3.jpg'), " +
        	    "('Medium', 5.8, 'Back Yard', 14.5, 'tree10_pic1.jpg', 'tree10_pic2.jpg', 'tree10_pic3.jpg');"
        	);

        
        String quoteRequestDataGeneration = (
        	    "INSERT INTO QuoteRequest (TreeID, ClientID, DateSubmitted, Status, ClientNote) VALUES " +
        	    "(1, 101, '2023-10-01', 'pending', 'Client needs a quote for tree trimming.'), " +
        	    "(2, 102, '2023-10-02', 'pending', 'Requesting quote for tree removal.'), " +
        	    "(3, 103, '2023-10-03', 'accepted', 'Client approved the initial quote.'), " +
        	    "(4, 104, '2023-10-04', 'pending', 'Interested in tree pruning services.'), " +
        	    "(5, 105, '2023-10-05', 'pending', 'Client requires a quote for tree maintenance.'), " +
        	    "(6, 106, '2023-10-06', 'accepted', 'Client accepted the initial quote for tree removal.'), " +
        	    "(7, 107, '2023-10-07', 'pending', 'Requesting quote for tree trimming in schoolyard.'), " +
        	    "(8, 108, '2023-10-08', 'pending', 'Client needs a quote for tree pruning in the playground.'), " +
        	    "(9, 109, '2023-10-09', 'accepted', 'Client approved the quote for tree maintenance.'), " +
        	    "(10, 110, '2023-10-10', 'pending', 'Interested in tree trimming services for the backyard.');"
        	);

        
        String quoteDataGeneration = (
        	    "INSERT INTO Quote (QuoteRequestID, Price, WorkPeriodStartDate, WorkPeriodEndDate, DateSubmitted, Status, Note) VALUES " +
        	    "(1, 500.00, '2023-10-05', '2023-10-10', '2023-10-04', 'pending', 'Initial quote for tree trimming.'), " +
        	    "(2, 1200.00, '2023-10-08', '2023-10-15', '2023-10-06', 'accepted', 'Quote for tree removal approved.'), " +
        	    "(3, 300.00, '2023-10-12', '2023-10-18', '2023-10-09', 'accepted', 'Finalized quote for tree pruning.'), " +
        	    "(4, 150.00, '2023-10-15', '2023-10-20', '2023-10-11', 'pending', 'Initial quote for tree pruning.'), " +
        	    "(5, 250.00, '2023-10-18', '2023-10-25', '2023-10-14', 'pending', 'Quote for tree maintenance services.'), " +
        	    "(6, 800.00, '2023-10-20', '2023-10-28', '2023-10-16', 'accepted', 'Quote for tree removal accepted.'), " +
        	    "(7, 400.00, '2023-10-25', '2023-10-30', '2023-10-19', 'pending', 'Initial quote for tree trimming in schoolyard.'), " +
        	    "(8, 600.00, '2023-10-28', '2023-11-05', '2023-10-22', 'pending', 'Quote for tree pruning in the playground.'), " +
        	    "(9, 200.00, '2023-10-30', '2023-11-08', '2023-10-25', 'accepted', 'Finalized quote for tree maintenance.'), " +
        	    "(10, 350.00, '2023-11-02', '2023-11-10', '2023-10-28', 'pending', 'Quote for tree trimming in the backyard.');"
        	);

        
        String orderOfWorkDataGeneration = (
        	    "INSERT INTO OrderOfWork (QuoteID, DateCreated, Status) VALUES " +
        	    "(1, '2023-10-10', 'in progress'), " +
        	    "(2, '2023-10-15', 'completed'), " +
        	    "(3, '2023-10-18', 'in progress'), " +
        	    "(4, '2023-10-20', 'in progress'), " +
        	    "(5, '2023-10-25', 'in progress'), " +
        	    "(6, '2023-10-28', 'completed'), " +
        	    "(7, '2023-10-30', 'in progress'), " +
        	    "(8, '2023-11-02', 'in progress'), " +
        	    "(9, '2023-11-05', 'completed'), " +
        	    "(10, '2023-11-08', 'in progress');"
        	);

        
        String billDataGeneration = (
        	    "INSERT INTO Bill (OrderOfWorkID, AmountDue, DateIssued, Status, Note) VALUES " +
        	    "(1, 500.00, '2023-10-12', 'pending', 'Amount due for tree trimming work.'), " +
        	    "(2, 1200.00, '2023-10-20', 'paid', 'Payment received for tree removal.'), " +
        	    "(3, 300.00, '2023-10-25', 'pending', 'Amount due for tree pruning work.'), " +
        	    "(4, 150.00, '2023-10-28', 'pending', 'Amount due for tree pruning work.'), " +
        	    "(5, 250.00, '2023-11-02', 'pending', 'Amount due for tree maintenance work.'), " +
        	    "(6, 800.00, '2023-11-08', 'paid', 'Payment received for tree removal.'), " +
        	    "(7, 400.00, '2023-11-12', 'pending', 'Amount due for tree trimming work in schoolyard.'), " +
        	    "(8, 600.00, '2023-11-18', 'pending', 'Amount due for tree pruning work in the playground.'), " +
        	    "(9, 200.00, '2023-11-22', 'paid', 'Payment received for tree maintenance work.'), " +
        	    "(10, 350.00, '2023-11-28', 'pending', 'Amount due for tree trimming work in the backyard.');"
        	);

        
        String billDisputeDataGeneration = (
        	    "INSERT INTO BillDispute (BillID, ClientID, TimeAndDate, Changelog) VALUES " +
        	    "(1, 101, '2023-10-14 15:30:00', 'Client disputes the tree trimming charge.'), " +
        	    "(2, 3, '2023-10-28 10:45:00', 'Client queries the additional charge for tree pruning.'), " +
        	    "(3, 5, '2023-11-05 12:15:00', 'Client disputes the tree maintenance charge.'), " +
        	    "(4, 7, '2023-11-12 14:00:00', 'Client disputes the schoolyard tree trimming charge.'), " +
        	    "(5, 10, '2023-11-30 09:30:00', 'Client queries the tree trimming charge for the backyard.'), " +
        	    "(6, 2, '2023-10-22 11:00:00', 'Client disputes the tree removal charge.'), " +
        	    "(7, 4, '2023-10-30 13:45:00', 'Client queries the additional charge for tree pruning.'), " +
        	    "(8, 6, '2023-11-10 16:20:00', 'Client disputes the tree removal charge.'), " +
        	    "(9, 8, '2023-11-18 09:00:00', 'Client queries the additional charge for tree pruning.'), " +
        	    "(10, 9, '2023-11-25 14:30:00', 'Client disputes the tree maintenance charge.');"
        	);



        
        //for loop to put these in database
        for (int i = 0; i < INITIAL.length; i++)
        	statement.execute(INITIAL[i]);
        
        //statement.execute(clientTableCreation);
        //statement.execute(clientDataGeneration);
        
        String[] sqlStatements = {
        	    treeTableCreation,
        	    quoteRequestTableCreation,
        	    quoteTableCreation,
        	    orderOfWorkTableCreation,
        	    billTableCreation,
        	    billDisputeTableCreation,
        	    clientTableCreation,
        	    treeDataGeneration,
        	    quoteRequestDataGeneration,
        	    quoteDataGeneration,
        	    orderOfWorkDataGeneration,
        	    billDataGeneration,
        	    billDisputeDataGeneration,
        	    clientDataGeneration
        	};

        	// Execute SQL statements in a loop
        for (int i = 0; i < sqlStatements.length; i++) {
        	statement.execute(sqlStatements[i]);
        }
        
        disconnect();
    }
    
    
   
    
    
    
    
    
	
	

}
